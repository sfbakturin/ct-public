# Протокол DNS

**Среда выполнения**: виртуальная машина (VirtualBox), выбранная операционная система - Ubuntu Desktop.

## Часть 1. Структура DNS-серверов

Для получения IP адреса домена [`nerc.itmo.ru`](nerc.itmo.ru) воспользуемся приложением `dig` - утилита DNS lookup, предназначенная для поиска DNS по запрошенным серверам. Получаем много интересной информации, среди которой находим IP адрес - *77.234.215.132*.

```bash
dig nerc.itmo.ru
```

Для получения адресов с корневого `a.root-servers.net` также воспользуемся утилитой `dig`, только в качестве аргументов мы подаем адрес, с которого мы будем осуществлять запрос - он нам выдаст другие адреса (в части ADDITIONAL), от которых мы также продолжаем высылать запросы.

```bash
dig @a.root-servers.net nerc.itmo.ru
```

## Часть 2. DNS-сервер

Для создания своего мини-сервер воспользуемся приложением BIND. Для начала установим себе заданный IP адрес для `tap0` и установим себе пакет `bind9`. На Ubuntu для настройки по умолчанию используются следующие файлы:

* `/etc/bind/named.conf.options` - для всех глобальных настроек;
* `/etc/bind/named.conf.local` - для описания типа и файла с настройками под конкретную зону.

Настройки для `named.conf.options` следующие:

* поле `directory "/path/to/caches";` определяет, куда следует складывать все файлы, кэши и так далее;
* `listen-on-v6 port 53 { any; };` - мы указываем любые IPv6 запросы от любых источников на порту по умолчанию;
* `allow-query { any; };` - разрешим любому источнику отправлять запрос к нам;
* `recursion yes;` - сервер умеет и может делать рекурсивные запросы;
* `listen-on port 53 { 127.0.0.1; 10.52.1.1; };` - мы указываем любые IPv4 запросы от источников localhost и выданного по заданию адреса на порту по умолчанию;
* `forwarders { 8.8.8.8; };` - перенаправление запросов.

Настройки для `named.conf.local` следующие:

* зададим зону: `zone "0qnzt88nu6.localnetwork"`.
* `type master;` - указываем тип нашей зоны под данный домен;
* `file "/etc/bind/0qnzt88nu6.localnetwork.conf";` - полный путь к файлу настроек данной зоны.

Наконец, настройки под данную зону:

* `$TTL` - так называемый *time to live* - отвечает за время существования кеша DNS сервера;
* `@ IN SOA ns.0qnzt88nu6.localnetwork. noreply.0qnzt88nu6.localnetwork. ( ... )` - здесь мы указываем саму зону, в качестве `ns.0qnzt88nu6.localnetwork` - доменное имя сервера, `noreply.0qnzt88nu6.localnetwork` - адрес администратора, далее `...` идут числа - это серийный номер и настройки времени (частота обновлений, время ожидания и т. д.);
* `@ IN NS ns.0qnzt88nu6.localnetwork.` - адрес, который обслуживает наша зона;
* `ns.0qnzt88nu6.localnetwork. IN A 10.52.1.1` - связь между доменом и IP адресом VPN.
* `@ IN A 10.52.1.148` - запись, необходимая для ответа IPv4-адресом;
* `@ IN AAAA fd44:1337::40a7:eaa5:6a5e:ab68` - запись, необходимая для ответа IPv6-адресом;
* `@ IN MX 10 mx.example.org.` - запись, необходимо для возврата адреса администратора сервера с приоритетом 10;
* `3d2bv.0qnzt88nu6.localnetwork. IN AAAA fd44:1337::894b:7420:e2d2:e750` - добавленный поддомен для указания на адрес.
